//
// colormap.s — Iteration count → RGB palette mapping (AArch64 / macOS)
//
// void colormap_apply(uint8_t *rgb_out, const uint32_t *iter_in,
//                     uint32_t count, uint32_t max_iter);
//
// Arguments:
//   x0 = rgb_out       (uint8_t*)
//   x1 = iter_in       (const uint32_t*)
//   w2 = count          (uint32_t)
//   w3 = max_iter       (uint32_t)
//
// For each pixel:
//   if iter >= max_iter → black (0, 0, 0)
//   else index = (iter * 255) / max_iter → palette[index]
//
// Uses only caller-saved registers (x0-x15) — no prologue needed.
//

.text
.globl _colormap_apply
.p2align 4

_colormap_apply:
    // Move args to scratch regs so we can reuse x0-x3
    mov     x9, x0              // rgb_out (advancing)
    mov     x10, x1             // iter_in (advancing)
    mov     w11, w2             // remaining count
    mov     w12, w3             // max_iter

    adrp    x13, _palette@PAGE
    add     x13, x13, _palette@PAGEOFF

    cbz     w11, .Lcm_done

.Lcm_loop:
    ldr     w14, [x10], #4     // iter = *iter_in++

    cmp     w14, w12
    b.hs    .Lcm_black          // iter >= max_iter → black

    // index = (iter * 255) / max_iter
    mov     w15, #255
    mul     w14, w14, w15
    udiv    w14, w14, w12

    // palette lookup: &palette[index * 3]
    add     w15, w14, w14, lsl #1   // index * 3
    add     x15, x13, w15, uxtw

    ldrb    w0, [x15]          // R
    ldrb    w1, [x15, #1]      // G
    ldrb    w2, [x15, #2]      // B

    strb    w0, [x9]
    strb    w1, [x9, #1]
    strb    w2, [x9, #2]
    add     x9, x9, #3

    subs    w11, w11, #1
    b.ne    .Lcm_loop
    b       .Lcm_done

.Lcm_black:
    strb    wzr, [x9]
    strb    wzr, [x9, #1]
    strb    wzr, [x9, #2]
    add     x9, x9, #3

    subs    w11, w11, #1
    b.ne    .Lcm_loop

.Lcm_done:
    ret


// ══════════════════════════════════════════════════════════
//  256-entry RGB palette (768 bytes)
//  Full-spectrum high-contrast gradient:
//    deep blue → blue → cyan → green → gold → orange → pink → purple → deep blue
// ══════════════════════════════════════════════════════════

.section __DATA,__data
.p2align 4
.globl _palette
_palette:
    .byte 0, 0, 40, 0, 0, 41, 0, 1, 43, 0, 2, 46, 0, 3, 50, 0, 5, 56, 0, 7, 62, 0, 10, 70
    .byte 0, 12, 78, 0, 15, 86, 0, 18, 96, 0, 21, 106, 0, 25, 116, 0, 28, 126, 0, 32, 137, 0, 35, 148
    .byte 0, 38, 158, 0, 42, 169, 0, 45, 179, 0, 49, 189, 0, 52, 199, 0, 55, 209, 0, 58, 217, 0, 60, 225
    .byte 0, 63, 233, 0, 65, 239, 0, 67, 245, 0, 68, 249, 0, 69, 252, 0, 70, 254, 0, 70, 255, 0, 70, 255
    .byte 0, 72, 255, 0, 74, 255, 0, 77, 255, 0, 80, 255, 0, 85, 255, 0, 89, 255, 0, 95, 255, 0, 100, 255
    .byte 0, 106, 255, 0, 113, 255, 0, 119, 255, 0, 126, 255, 0, 133, 255, 0, 140, 255, 0, 147, 255, 0, 154, 255
    .byte 0, 161, 255, 0, 167, 255, 0, 174, 255, 0, 180, 255, 0, 185, 255, 0, 191, 255, 0, 195, 255, 0, 200, 255
    .byte 0, 203, 255, 0, 206, 255, 0, 208, 255, 0, 210, 255, 0, 210, 255, 0, 210, 254, 0, 211, 253, 0, 211, 251
    .byte 0, 212, 247, 1, 213, 244, 1, 215, 239, 1, 216, 234, 2, 218, 228, 2, 220, 222, 3, 222, 215, 3, 224, 208
    .byte 4, 226, 200, 4, 228, 193, 5, 230, 185, 5, 233, 178, 6, 235, 170, 6, 237, 162, 6, 239, 155, 7, 241, 147
    .byte 7, 243, 140, 8, 245, 133, 8, 247, 127, 9, 249, 121, 9, 250, 116, 9, 252, 111, 10, 253, 108, 10, 254, 104
    .byte 10, 254, 102, 10, 255, 101, 10, 255, 100, 11, 255, 100, 13, 255, 99, 16, 255, 97, 20, 255, 95, 26, 255, 93
    .byte 32, 255, 90, 39, 255, 86, 47, 255, 82, 55, 255, 78, 64, 255, 74, 74, 255, 70, 84, 255, 65, 94, 255, 60
    .byte 105, 255, 55, 115, 255, 50, 125, 255, 45, 136, 255, 40, 146, 255, 35, 156, 255, 30, 166, 255, 26, 175, 255, 22
    .byte 183, 255, 18, 191, 255, 14, 198, 255, 10, 204, 255, 7, 210, 255, 5, 214, 255, 3, 217, 255, 1, 219, 255, 0
    .byte 220, 255, 0, 220, 255, 0, 221, 254, 0, 221, 252, 0, 222, 250, 0, 224, 247, 0, 225, 244, 0, 227, 241, 0
    .byte 228, 237, 0, 230, 233, 0, 232, 229, 0, 234, 224, 0, 236, 220, 0, 239, 215, 0, 241, 211, 0, 243, 206, 0
    .byte 245, 202, 0, 247, 198, 0, 248, 194, 0, 250, 191, 0, 251, 188, 0, 253, 185, 0, 254, 183, 0, 254, 181, 0
    .byte 255, 180, 0, 255, 180, 0, 255, 179, 0, 255, 177, 0, 255, 174, 1, 255, 170, 2, 255, 165, 2, 255, 160, 3
    .byte 255, 153, 4, 255, 147, 6, 255, 139, 7, 255, 132, 8, 255, 124, 9, 255, 116, 11, 255, 108, 12, 255, 101, 13
    .byte 255, 93, 14, 255, 87, 16, 255, 80, 17, 255, 75, 18, 255, 70, 18, 255, 66, 19, 255, 63, 20, 255, 61, 20
    .byte 255, 60, 20, 255, 60, 21, 255, 59, 22, 255, 58, 25, 255, 57, 29, 255, 56, 33, 255, 55, 38, 255, 53, 44
    .byte 255, 51, 50, 255, 49, 57, 255, 47, 63, 255, 45, 70, 255, 43, 77, 255, 41, 83, 255, 39, 90, 255, 37, 96
    .byte 255, 35, 102, 255, 34, 107, 255, 33, 111, 255, 32, 115, 255, 31, 118, 255, 30, 119, 255, 30, 120, 255, 30, 121
    .byte 253, 29, 122, 252, 29, 125, 249, 28, 129, 246, 27, 134, 243, 26, 140, 239, 24, 146, 234, 23, 153, 230, 21, 160
    .byte 225, 19, 168, 220, 18, 175, 215, 16, 183, 210, 14, 192, 205, 12, 200, 200, 11, 207, 195, 9, 215, 191, 7, 222
    .byte 186, 6, 229, 182, 4, 235, 179, 3, 241, 176, 2, 246, 173, 1, 250, 172, 1, 253, 170, 0, 254, 170, 0, 255
    .byte 169, 0, 254, 167, 0, 253, 164, 0, 250, 160, 0, 246, 155, 0, 241, 150, 0, 236, 143, 0, 230, 137, 0, 223
    .byte 129, 0, 216, 122, 0, 209, 114, 0, 201, 106, 0, 194, 98, 0, 186, 91, 0, 179, 83, 0, 172, 77, 0, 165
    .byte 70, 0, 159, 65, 0, 154, 60, 0, 149, 56, 0, 145, 53, 0, 142, 51, 0, 141, 50, 0, 140, 50, 0, 139
    .byte 48, 0, 136, 46, 0, 132, 43, 0, 126, 40, 0, 119, 36, 0, 111, 32, 0, 103, 27, 0, 94, 23, 0, 86
    .byte 18, 0, 77, 14, 0, 69, 10, 0, 61, 7, 0, 54, 4, 0, 48, 2, 0, 44, 0, 0, 41, 0, 0, 40

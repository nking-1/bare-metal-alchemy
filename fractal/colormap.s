//
// colormap.s — Iteration count → RGB palette mapping (AArch64 / macOS)
//
// void colormap_apply(uint8_t *rgb_out, const uint32_t *iter_in,
//                     uint32_t count, uint32_t max_iter);
//
// Arguments:
//   x0 = rgb_out       (uint8_t*)
//   x1 = iter_in       (const uint32_t*)
//   w2 = count          (uint32_t)
//   w3 = max_iter       (uint32_t)
//
// For each pixel:
//   if iter >= max_iter → black (0, 0, 0)
//   else index = (iter * 255) / max_iter → palette[index]
//
// Uses only caller-saved registers (x0-x15) — no prologue needed.
//

.text
.globl _colormap_apply
.p2align 4

_colormap_apply:
    // Move args to scratch regs so we can reuse x0-x3
    mov     x9, x0              // rgb_out (advancing)
    mov     x10, x1             // iter_in (advancing)
    mov     w11, w2             // remaining count
    mov     w12, w3             // max_iter

    adrp    x13, _palette@PAGE
    add     x13, x13, _palette@PAGEOFF

    cbz     w11, .Lcm_done

.Lcm_loop:
    ldr     w14, [x10], #4     // iter = *iter_in++

    cmp     w14, w12
    b.hs    .Lcm_black          // iter >= max_iter → black

    // index = (iter * 255) / max_iter
    mov     w15, #255
    mul     w14, w14, w15
    udiv    w14, w14, w12

    // palette lookup: &palette[index * 3]
    add     w15, w14, w14, lsl #1   // index * 3
    add     x15, x13, w15, uxtw

    ldrb    w0, [x15]          // R
    ldrb    w1, [x15, #1]      // G
    ldrb    w2, [x15, #2]      // B

    strb    w0, [x9]
    strb    w1, [x9, #1]
    strb    w2, [x9, #2]
    add     x9, x9, #3

    subs    w11, w11, #1
    b.ne    .Lcm_loop
    b       .Lcm_done

.Lcm_black:
    strb    wzr, [x9]
    strb    wzr, [x9, #1]
    strb    wzr, [x9, #2]
    add     x9, x9, #3

    subs    w11, w11, #1
    b.ne    .Lcm_loop

.Lcm_done:
    ret


// ══════════════════════════════════════════════════════════
//  256-entry RGB palette (768 bytes)
//  Cool gradient:
//    deep navy → blue → cyan → teal → purple → indigo → deep navy
// ══════════════════════════════════════════════════════════

.section __DATA,__data
.p2align 4
.globl _palette
_palette:
    .byte 2, 3, 30, 2, 3, 30, 2, 3, 31, 2, 4, 32, 2, 4, 34, 2, 5, 37, 2, 6, 39, 3, 7, 43
    .byte 3, 8, 46, 3, 10, 50, 3, 11, 54, 3, 13, 59, 4, 14, 64, 4, 16, 69, 4, 18, 74, 4, 20, 80
    .byte 5, 22, 85, 5, 23, 91, 5, 25, 97, 5, 27, 103, 6, 29, 109, 6, 32, 115, 6, 34, 121, 7, 36, 127
    .byte 7, 38, 133, 7, 40, 139, 7, 41, 145, 8, 43, 150, 8, 45, 156, 8, 47, 161, 8, 49, 166, 9, 50, 171
    .byte 9, 52, 176, 9, 53, 180, 9, 55, 184, 9, 56, 187, 10, 57, 191, 10, 58, 193, 10, 59, 196, 10, 59, 198
    .byte 10, 60, 199, 10, 60, 200, 10, 60, 200, 10, 60, 200, 10, 61, 200, 10, 62, 201, 10, 63, 201, 10, 65, 202
    .byte 11, 67, 203, 11, 70, 204, 11, 73, 205, 11, 76, 206, 11, 79, 208, 12, 83, 209, 12, 87, 210, 12, 91, 212
    .byte 12, 95, 214, 13, 99, 215, 13, 104, 217, 13, 108, 219, 14, 113, 221, 14, 118, 223, 14, 123, 225, 15, 128, 227
    .byte 15, 132, 228, 16, 137, 230, 16, 142, 232, 16, 147, 234, 17, 152, 236, 17, 156, 238, 17, 161, 240, 18, 165, 241
    .byte 18, 169, 243, 18, 173, 245, 18, 177, 246, 19, 181, 247, 19, 184, 249, 19, 187, 250, 19, 190, 251, 19, 193, 252
    .byte 20, 195, 253, 20, 197, 254, 20, 198, 254, 20, 199, 255, 20, 200, 255, 20, 200, 255, 20, 200, 255, 20, 200, 254
    .byte 20, 200, 254, 20, 200, 253, 20, 199, 251, 19, 199, 250, 19, 199, 248, 19, 198, 246, 19, 198, 244, 19, 197, 242
    .byte 18, 197, 240, 18, 196, 237, 18, 196, 234, 18, 195, 231, 17, 194, 228, 17, 194, 225, 17, 193, 222, 16, 192, 219
    .byte 16, 192, 216, 16, 191, 212, 15, 190, 209, 15, 190, 206, 14, 189, 203, 14, 188, 199, 14, 188, 196, 13, 187, 193
    .byte 13, 186, 190, 13, 186, 187, 12, 185, 184, 12, 184, 181, 12, 184, 178, 12, 183, 175, 11, 183, 173, 11, 182, 171
    .byte 11, 182, 169, 11, 181, 167, 11, 181, 165, 10, 181, 164, 10, 180, 162, 10, 180, 161, 10, 180, 161, 10, 180, 160
    .byte 10, 180, 160, 10, 180, 160, 11, 179, 160, 11, 178, 161, 12, 176, 161, 14, 174, 162, 15, 172, 162, 17, 169, 163
    .byte 19, 166, 164, 21, 162, 165, 23, 159, 166, 25, 155, 167, 28, 150, 168, 31, 146, 169, 33, 141, 170, 36, 136, 172
    .byte 39, 131, 173, 42, 126, 174, 45, 121, 176, 49, 116, 177, 52, 110, 179, 55, 105, 180, 58, 100, 181, 61, 94, 183
    .byte 65, 89, 184, 68, 84, 186, 71, 79, 187, 74, 74, 188, 77, 69, 190, 79, 64, 191, 82, 60, 192, 85, 55, 193
    .byte 87, 51, 194, 89, 48, 195, 91, 44, 196, 93, 41, 197, 95, 38, 198, 96, 36, 198, 98, 34, 199, 99, 32, 199
    .byte 99, 31, 200, 100, 30, 200, 100, 30, 200, 100, 30, 200, 100, 30, 199, 99, 30, 198, 98, 29, 197, 97, 29, 196
    .byte 96, 29, 194, 95, 28, 192, 94, 28, 190, 92, 27, 188, 90, 27, 185, 89, 26, 182, 87, 25, 179, 85, 25, 176
    .byte 83, 24, 173, 80, 23, 169, 78, 22, 166, 76, 21, 162, 73, 21, 158, 71, 20, 155, 69, 19, 151, 66, 18, 147
    .byte 64, 17, 143, 61, 16, 139, 59, 15, 135, 57, 14, 132, 54, 14, 128, 52, 13, 124, 50, 12, 121, 47, 11, 117
    .byte 45, 10, 114, 43, 10, 111, 41, 9, 108, 40, 8, 105, 38, 8, 102, 36, 7, 100, 35, 7, 98, 34, 6, 96
    .byte 33, 6, 94, 32, 6, 93, 31, 5, 92, 30, 5, 91, 30, 5, 90, 30, 5, 90, 30, 5, 90, 30, 5, 90
    .byte 30, 5, 89, 29, 5, 88, 29, 5, 88, 28, 5, 87, 28, 5, 86, 27, 5, 84, 27, 5, 83, 26, 5, 81
    .byte 25, 5, 80, 24, 5, 78, 24, 5, 76, 23, 4, 74, 22, 4, 73, 21, 4, 71, 20, 4, 68, 19, 4, 66
    .byte 18, 4, 64, 17, 4, 62, 16, 4, 60, 15, 4, 58, 14, 4, 56, 13, 4, 54, 12, 4, 52, 11, 4, 49
    .byte 10, 4, 47, 9, 4, 46, 8, 3, 44, 8, 3, 42, 7, 3, 40, 6, 3, 39, 5, 3, 37, 5, 3, 36
    .byte 4, 3, 34, 4, 3, 33, 3, 3, 32, 3, 3, 32, 2, 3, 31, 2, 3, 30, 2, 3, 30, 2, 3, 30

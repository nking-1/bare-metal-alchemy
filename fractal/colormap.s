//
// colormap.s — Iteration count → RGB palette mapping (AArch64 / macOS)
//
// void colormap_apply(uint8_t *rgb_out, const uint32_t *iter_in,
//                     uint32_t count, uint32_t max_iter);
//
// Arguments:
//   x0 = rgb_out       (uint8_t*)
//   x1 = iter_in       (const uint32_t*)
//   w2 = count          (uint32_t)
//   w3 = max_iter       (uint32_t)
//
// For each pixel:
//   if iter >= max_iter → black (0, 0, 0)
//   else index = (iter * 255) / max_iter → palette[index]
//
// Uses only caller-saved registers (x0-x15) — no prologue needed.
//

.text
.globl _colormap_apply
.p2align 4

_colormap_apply:
    // Move args to scratch regs so we can reuse x0-x3
    mov     x9, x0              // rgb_out (advancing)
    mov     x10, x1             // iter_in (advancing)
    mov     w11, w2             // remaining count
    mov     w12, w3             // max_iter

    adrp    x13, _palette@PAGE
    add     x13, x13, _palette@PAGEOFF

    cbz     w11, .Lcm_done

.Lcm_loop:
    ldr     w14, [x10], #4     // iter = *iter_in++

    cmp     w14, w12
    b.hs    .Lcm_black          // iter >= max_iter → black

    // index = (iter * 255) / max_iter
    mov     w15, #255
    mul     w14, w14, w15
    udiv    w14, w14, w12

    // palette lookup: &palette[index * 3]
    add     w15, w14, w14, lsl #1   // index * 3
    add     x15, x13, w15, uxtw

    ldrb    w0, [x15]          // R
    ldrb    w1, [x15, #1]      // G
    ldrb    w2, [x15, #2]      // B

    strb    w0, [x9]
    strb    w1, [x9, #1]
    strb    w2, [x9, #2]
    add     x9, x9, #3

    subs    w11, w11, #1
    b.ne    .Lcm_loop
    b       .Lcm_done

.Lcm_black:
    strb    wzr, [x9]
    strb    wzr, [x9, #1]
    strb    wzr, [x9, #2]
    add     x9, x9, #3

    subs    w11, w11, #1
    b.ne    .Lcm_loop

.Lcm_done:
    ret


// ══════════════════════════════════════════════════════════
//  256-entry RGB palette (768 bytes)
//  Ultra Fractal-style gradient:
//    dark blue → medium blue → white/cyan → orange → near black → dark blue
// ══════════════════════════════════════════════════════════

.section __DATA,__data
.p2align 4
.globl _palette
_palette:
    .byte 0, 7, 100, 1, 9, 103, 2, 12, 105, 2, 14, 108, 3, 17, 110, 4, 19, 113, 5, 22, 115, 5, 24, 118
    .byte 6, 27, 120, 7, 29, 123, 8, 31, 125, 9, 34, 128, 9, 36, 130, 10, 39, 133, 11, 41, 135, 12, 44, 138
    .byte 12, 46, 140, 13, 48, 143, 14, 51, 145, 15, 53, 148, 16, 56, 150, 16, 58, 153, 17, 61, 155, 18, 63, 158
    .byte 19, 66, 160, 20, 68, 163, 20, 70, 165, 21, 73, 168, 22, 75, 170, 23, 78, 173, 23, 80, 175, 24, 83, 178
    .byte 25, 85, 180, 26, 87, 183, 27, 90, 185, 27, 92, 188, 28, 95, 190, 29, 97, 193, 30, 100, 195, 30, 102, 198
    .byte 31, 105, 200, 32, 107, 203, 35, 109, 204, 38, 111, 205, 41, 114, 205, 44, 116, 206, 48, 118, 207, 51, 120, 208
    .byte 54, 123, 209, 57, 125, 209, 60, 127, 210, 63, 129, 211, 66, 132, 212, 69, 134, 212, 72, 136, 213, 75, 138, 214
    .byte 79, 141, 215, 82, 143, 216, 85, 145, 216, 88, 147, 217, 91, 150, 218, 94, 152, 219, 97, 154, 220, 100, 156, 220
    .byte 103, 159, 221, 107, 161, 222, 110, 163, 223, 113, 165, 223, 116, 168, 224, 119, 170, 225, 122, 172, 226, 125, 174, 227
    .byte 128, 177, 227, 131, 179, 228, 135, 181, 229, 138, 183, 230, 141, 185, 231, 144, 188, 231, 147, 190, 232, 150, 192, 233
    .byte 153, 194, 234, 156, 197, 235, 159, 199, 235, 162, 201, 236, 166, 203, 237, 169, 206, 238, 172, 208, 238, 175, 210, 239
    .byte 178, 212, 240, 181, 215, 241, 184, 217, 242, 187, 219, 242, 190, 221, 243, 194, 224, 244, 197, 226, 245, 200, 228, 246
    .byte 203, 230, 246, 206, 233, 247, 209, 235, 248, 212, 237, 249, 215, 239, 249, 218, 242, 250, 221, 244, 251, 225, 246, 252
    .byte 228, 248, 253, 231, 251, 253, 234, 253, 254, 237, 255, 255, 237, 254, 251, 238, 252, 246, 238, 251, 242, 238, 249, 237
    .byte 239, 248, 233, 239, 246, 228, 239, 245, 224, 240, 243, 219, 240, 242, 215, 240, 240, 210, 240, 239, 206, 241, 237, 201
    .byte 241, 236, 197, 241, 234, 192, 242, 233, 188, 242, 231, 183, 242, 230, 179, 243, 228, 174, 243, 227, 170, 243, 225, 166
    .byte 244, 224, 161, 244, 222, 157, 244, 221, 152, 245, 219, 148, 245, 218, 143, 245, 216, 139, 246, 215, 134, 246, 213, 130
    .byte 246, 212, 125, 246, 210, 121, 247, 209, 116, 247, 207, 112, 247, 206, 107, 248, 204, 103, 248, 203, 98, 248, 201, 94
    .byte 249, 200, 89, 249, 198, 85, 249, 197, 81, 250, 195, 76, 250, 194, 72, 250, 192, 67, 251, 191, 63, 251, 189, 58
    .byte 251, 188, 54, 252, 186, 49, 252, 185, 45, 252, 183, 40, 252, 182, 36, 253, 180, 31, 253, 179, 27, 253, 177, 22
    .byte 254, 176, 18, 254, 174, 13, 254, 173, 9, 255, 171, 4, 255, 170, 0, 250, 167, 0, 246, 164, 0, 241, 161, 0
    .byte 236, 158, 0, 232, 155, 0, 227, 152, 0, 223, 149, 0, 218, 146, 0, 213, 143, 0, 209, 139, 0, 204, 136, 0
    .byte 199, 133, 0, 195, 130, 0, 190, 127, 0, 185, 124, 0, 181, 121, 0, 176, 118, 0, 172, 115, 0, 167, 112, 0
    .byte 162, 109, 0, 158, 106, 0, 153, 103, 0, 148, 100, 0, 144, 97, 0, 139, 94, 0, 134, 91, 0, 130, 88, 0
    .byte 125, 84, 0, 121, 81, 0, 116, 78, 0, 111, 75, 0, 107, 72, 0, 102, 69, 0, 97, 66, 0, 93, 63, 0
    .byte 88, 60, 0, 83, 57, 0, 79, 54, 0, 74, 51, 0, 70, 48, 0, 65, 45, 0, 60, 42, 0, 56, 39, 0
    .byte 51, 36, 0, 46, 33, 0, 42, 29, 0, 37, 26, 0, 32, 23, 0, 28, 20, 0, 23, 17, 0, 19, 14, 0
    .byte 14, 11, 0, 9, 8, 0, 5, 5, 0, 0, 2, 0, 0, 2, 3, 0, 2, 6, 0, 2, 8, 0, 3, 11
    .byte 0, 3, 14, 0, 3, 17, 0, 3, 19, 0, 3, 22, 0, 3, 25, 0, 3, 28, 0, 4, 31, 0, 4, 33
    .byte 0, 4, 36, 0, 4, 39, 0, 4, 42, 0, 4, 44, 0, 4, 47, 0, 5, 50, 0, 5, 53, 0, 5, 56
    .byte 0, 5, 58, 0, 5, 61, 0, 5, 64, 0, 5, 67, 0, 5, 69, 0, 6, 72, 0, 6, 75, 0, 6, 78
    .byte 0, 6, 81, 0, 6, 83, 0, 6, 86, 0, 6, 89, 0, 7, 92, 0, 7, 94, 0, 7, 97, 0, 7, 100
